<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planopoly - Interactive Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0f172a;
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body.light-mode {
            background: #f5e6d3;
            color: #1e293b;
        }

        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            background: linear-gradient(180deg, #1e293b 0%, rgba(30, 41, 59, 0.95) 100%);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 110;
            backdrop-filter: blur(8px);
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        body.light-mode #header {
            background: linear-gradient(180deg, #d9c9b0 0%, rgba(217, 201, 176, 0.95) 100%);
            border-bottom: 1px solid rgba(30, 41, 59, 0.15);
        }

        #header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #f1f5f9;
            transition: color 0.3s ease;
        }

        body.light-mode #header h1 {
            color: #1e293b;
        }

        #header .subtitle {
            font-size: 0.875rem;
            color: #64748b;
            margin-left: 12px;
        }

        body.light-mode #header .subtitle {
            color: #64748b;
        }

        #header .controls {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .btn-stack {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .btn-row {
            display: flex;
            flex-direction: row;
            gap: 4px;
        }

        .btn-square {
            width: 32px !important;
            height: 32px !important;
            padding: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.55rem !important;
        }

        .header-logo {
            height: 30px;
            width: auto;
            border: 2px solid #9ca3af;
            border-radius: 4px;
            margin-right: 12px;
            vertical-align: middle;
        }

        /* Sun/Moon theme toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 3px;
            cursor: pointer;
            user-select: none;
            font-size: 0.7rem;
        }

        .theme-toggle .icon {
            font-size: 0.75rem;
            line-height: 1;
        }

        .theme-toggle input {
            display: none;
        }

        .theme-toggle .slider {
            width: 32px;
            height: 16px;
            background: #cbd5e1;
            border-radius: 8px;
            position: relative;
            transition: background 0.3s ease;
        }

        .theme-toggle .slider::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .theme-toggle input:checked + .slider {
            background: #475569;
        }

        .theme-toggle input:checked + .slider::after {
            transform: translateX(16px);
        }

        .settings-icon {
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            line-height: 1;
        }

        .settings-icon:hover {
            opacity: 1;
        }

        /* Custom tooltips */
        [data-tip] {
            position: relative;
        }

        [data-tip]::after {
            content: attr(data-tip);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 6px;
            background: rgba(15, 23, 42, 0.95);
            color: #e2e8f0;
            font-size: 0.65rem;
            font-weight: 400;
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease;
            z-index: 300;
        }

        body.light-mode [data-tip]::after {
            background: rgba(30, 41, 59, 0.95);
            color: #f1f5f9;
        }

        [data-tip]:hover::after {
            opacity: 1;
        }

        #header button {
            background: #334155;
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: #e2e8f0;
            padding: 3px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.6rem;
            transition: all 0.2s;
        }

        body.light-mode #header button {
            background: #e8e4de;
            border: 1px solid rgba(30, 41, 59, 0.2);
            color: #1e293b;
        }

        #header button:hover {
            background: #475569;
            border-color: rgba(148, 163, 184, 0.3);
        }

        body.light-mode #header button:hover {
            background: #d4d0c8;
            border-color: rgba(30, 41, 59, 0.3);
        }

        #header button.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: #fff;
        }

        

        #legend {
            position: fixed;
            top: 54px;
            right: 16px;
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 8px;
            padding: 8px 10px;
            z-index: 100;
            backdrop-filter: blur(8px);
            min-width: 140px;
            max-height: calc(100vh - 70px);
            overflow-y: auto;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        body.light-mode #legend {
            background: rgba(217, 201, 176, 0.9);
            border: 1px solid rgba(30, 41, 59, 0.15);
        }

        #legend h3 {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 2px 5px;
            font-size: 0.7rem;
            color: #cbd5e1;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            margin: 1px 0;
        }

        body.light-mode .legend-item {
            color: #475569;
        }

        .legend-item:hover {
            background: rgba(148, 163, 184, 0.1);
        }

        body.light-mode .legend-item:hover {
            background: rgba(30, 41, 59, 0.1);
        }

        .legend-item.active {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        body.light-mode .legend-item.active {
            background: rgba(59, 130, 246, 0.2);
            color: #2563eb;
        }

        .legend-item.dimmed {
            opacity: 0.3;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .legend-clear {
            font-size: 0.6rem;
            color: #64748b;
            cursor: pointer;
            text-align: center;
            padding: 4px;
            margin-top: 4px;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
            transition: color 0.2s;
        }

        body.light-mode .legend-clear {
            border-top: 1px solid rgba(30, 41, 59, 0.1);
        }

        .legend-clear:hover {
            color: #94a3b8;
        }

        #sidepanel {
            position: fixed;
            top: 44px;
            left: -320px;
            width: 300px;
            height: calc(100vh - 44px);
            background: rgba(30, 41, 59, 0.98);
            border-right: 1px solid rgba(148, 163, 184, 0.1);
            z-index: 99;
            backdrop-filter: blur(8px);
            transition: left 0.3s ease, background 0.3s ease, border-color 0.3s ease;
            overflow-y: auto;
            padding: 20px;
        }

        body.light-mode #sidepanel {
            background: rgba(217, 201, 176, 0.98);
            border-right: 1px solid rgba(30, 41, 59, 0.15);
        }

        #sidepanel.open {
            left: 0;
        }

        #sidepanel .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #64748b;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        #sidepanel .close-btn:hover {
            background: rgba(148, 163, 184, 0.1);
            color: #94a3b8;
        }

        body.light-mode #sidepanel .close-btn:hover {
            background: rgba(30, 41, 59, 0.1);
            color: #475569;
        }

        #sidepanel h2 {
            font-size: 1.125rem;
            color: #f1f5f9;
            margin-bottom: 8px;
            margin-right: 32px;
            transition: color 0.3s ease;
        }

        body.light-mode #sidepanel h2 {
            color: #1e293b;
        }

        #sidepanel .role-badge {
            display: inline-block;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 16px;
            color: white;
            font-weight: 500;
        }

        #sidepanel .description {
            color: #cbd5e1;
            line-height: 1.5;
            margin-bottom: 20px;
            white-space: pre-wrap;
            transition: color 0.3s ease;
        }

        body.light-mode #sidepanel .description {
            color: #475569;
        }

        #sidepanel .section {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        body.light-mode #sidepanel .section {
            border-bottom: 1px solid rgba(30, 41, 59, 0.1);
        }

        #sidepanel .section:last-child {
            border-bottom: none;
        }

        #sidepanel h3 {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        body.light-mode #sidepanel h3 {
            color: #64748b;
        }

        #sidepanel .connection-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 0.8rem;
            color: #cbd5e1;
            cursor: pointer;
            border-radius: 4px;
            padding: 4px 8px;
            margin: 2px 0;
            transition: all 0.2s;
        }

        body.light-mode #sidepanel .connection-item {
            color: #475569;
        }

        #sidepanel .connection-item:hover {
            background: rgba(148, 163, 184, 0.1);
        }

        body.light-mode #sidepanel .connection-item:hover {
            background: rgba(30, 41, 59, 0.1);
        }

        #sidepanel .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        #sidepanel .resource-link {
            display: block;
            font-size: 0.8rem;
            color: #60a5fa;
            text-decoration: none;
            padding: 6px 8px;
            margin: 2px 0;
            border-radius: 4px;
            transition: all 0.2s;
        }

        body.light-mode #sidepanel .resource-link {
            color: #2563eb;
        }

        #sidepanel .resource-link:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #93c5fd;
        }

        body.light-mode #sidepanel .resource-link:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #1d4ed8;
        }

        #controls {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 6px;
            padding: 4px 8px;
            display: flex;
            gap: 5px;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(8px);
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        body.light-mode #controls {
            background: rgba(217, 201, 176, 0.9);
            border: 1px solid rgba(30, 41, 59, 0.15);
        }

        #controls button {
            background: #334155;
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: #e2e8f0;
            padding: 2px 7px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.5rem;
            transition: all 0.2s;
            line-height: 1.2;
        }

        body.light-mode #controls button {
            background: #e8e4de;
            border: 1px solid rgba(30, 41, 59, 0.2);
            color: #1e293b;
        }

        #controls button:hover {
            background: #475569;
            border-color: rgba(148, 163, 184, 0.3);
        }

        body.light-mode #controls button:hover {
            background: #d4d0c8;
            border-color: rgba(30, 41, 59, 0.3);
        }

        #controls .zoom-info {
            display: flex;
            align-items: center;
            color: #64748b;
            font-size: 0.45rem;
        }

        #canvas {
            width: 100%;
            height: 100vh;
            padding-top: 44px;
            transition: padding-left 0.3s ease;
        }

        #canvas.panel-open {
            padding-left: 300px;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        .node {
            cursor: pointer;
            transition: opacity 0.3s, transform 0.2s;
        }

        .node.dragging {
            cursor: grabbing !important;
        }

        .node .node-shape {
            stroke-width: 2;
            transition: all 0.3s;
        }

        .node:hover .node-shape {
            filter: brightness(1.2);
        }

        .node text {
            font-size: 11px;
            fill: #f8fafc;
            text-anchor: middle;
            pointer-events: none;
            font-weight: 500;
        }

        body.light-mode .node text {
            fill: #1e293b;
        }

        .node .role-badge {
            font-size: 9px;
            fill: rgba(248, 250, 252, 0.7);
            font-weight: 400;
        }

        .link {
            fill: none;
            stroke-width: 2;
            transition: opacity 0.3s, stroke-width 0.3s;
            pointer-events: none;
        }

        .link.dimmed {
            opacity: 0.1;
        }

        .link.highlighted {
            stroke-width: 3;
            opacity: 1;
        }

        .link.clickable {
            pointer-events: stroke;
            cursor: pointer;
        }

        .link.clickable:hover {
            stroke-width: 4;
            opacity: 0.8;
        }

        .link.selected-link {
            stroke: #f97316;
            stroke-width: 3;
            opacity: 1;
        }

        

        .node.dimmed {
            opacity: 0.15;
        }

        .node.role-filtered {
            opacity: 0.2;
        }

        .node.highlighted .node-shape {
            stroke-width: 3;
            filter: drop-shadow(0 0 8px currentColor);
        }

        .node.link-source .node-shape {
            stroke-width: 4;
            stroke: #f97316 !important;
            filter: drop-shadow(0 0 12px #f97316);
        }

        #tooltip {
            position: fixed;
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s, background 0.3s ease, border-color 0.3s ease;
            z-index: 200;
            max-width: 320px;
            backdrop-filter: blur(8px);
        }

        body.light-mode #tooltip {
            background: rgba(217, 201, 176, 0.98);
            border: 1px solid rgba(30, 41, 59, 0.2);
        }

        #tooltip.visible {
            opacity: 1;
        }

        #tooltip h4 {
            font-size: 0.875rem;
            color: #f1f5f9;
            margin-bottom: 6px;
        }

        body.light-mode #tooltip h4 {
            color: #1e293b;
        }

        #tooltip p {
            font-size: 0.75rem;
            color: #94a3b8;
            line-height: 1.4;
        }

        body.light-mode #tooltip p {
            color: #64748b;
        }

        #tooltip .role {
            display: inline-block;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            margin-top: 8px;
            color: white;
        }

        .instructions {
            position: fixed;
            bottom: 52px;
            left: 50%;
            transform: translateX(-50%);
            color: #64748b;
            font-size: 0.6rem;
            text-align: center;
            max-width: 600px;
            line-height: 1.3;
        }

        

        

        /* Nav links panel */
        #nav-links-panel {
            position: fixed;
            bottom: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 100;
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 6px;
            padding: 6px 8px;
            backdrop-filter: blur(8px);
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        body.light-mode #nav-links-panel {
            background: rgba(217, 201, 176, 0.9);
            border: 1px solid rgba(30, 41, 59, 0.15);
        }

        #nav-links-panel.hidden {
            display: none;
        }

        #nav-links-panel .nav-link-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #334155;
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: #e2e8f0;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.65rem;
            transition: all 0.2s;
            text-decoration: none;
            white-space: nowrap;
        }

        body.light-mode #nav-links-panel .nav-link-btn {
            background: #e8e4de;
            border: 1px solid rgba(30, 41, 59, 0.2);
            color: #1e293b;
        }

        #nav-links-panel .nav-link-btn:hover {
            background: #475569;
            border-color: rgba(148, 163, 184, 0.3);
        }

        body.light-mode #nav-links-panel .nav-link-btn:hover {
            background: #d4d0c8;
            border-color: rgba(30, 41, 59, 0.3);
        }

        

        

        /* Temporary link line */
        .temp-link {
            stroke: #f97316;
            stroke-width: 3;
            stroke-dasharray: 8,4;
            fill: none;
            pointer-events: none;
        }
    </style>
</head>
<body class="light-mode" style="cursor: default;">
    <div id="header">
        <img src="https://mr-robotto-66.github.io/robotto/planopoly_logo.jpeg" alt="Planopoly" class="header-logo">
        <div style="display: flex; align-items: baseline;">
            <h1 id="main-title" contenteditable="false">Planopoly</h1>
            <span class="subtitle" id="main-subtitle" contenteditable="false">TOC Post Award</span>
        </div>
        <div class="controls">
            <label class="theme-toggle">
                <span class="icon">‚òÄÔ∏è</span>
                <input type="checkbox" id="theme-checkbox" onchange="toggleLightDarkMode(true)">
                <span class="slider"></span>
                <span class="icon">üåô</span>
            </label>
            <div class="btn-row">
                
                <button onclick="toggleDragMode()" id="drag-btn" class="btn-square active" data-tip="Drag nodes to reposition them (D)">Lock</button>
            </div>
            
        </div>
    </div>

    

    <!-- Dynamic Legend (rebuilt by rebuildLegend()) -->
    <div id="legend"><h3>Responsibility or Process Description</h3><div class="legend-item" data-role="Engineering"><div class="legend-color" style="background: rgb(199, 194, 194);"></div>Engineering</div><div class="legend-item" data-role="Silviculture"><div class="legend-color" style="background: rgb(235, 10, 205);"></div>Silviculture</div><div class="legend-item" data-role="Post Award"><div class="legend-color" style="background: rgb(42, 141, 203);"></div>Post Award</div><div class="legend-item" data-role="LRM or Other Corp. Systems"><div class="legend-color" style="background: rgb(24, 192, 12);"></div>LRM or Other Corp. Systems</div><div class="legend-item" data-role="Communication Point"><div class="legend-color" style="background: rgb(145, 114, 33);"></div>Communication Point</div><div class="legend-item" data-role="BA / Admin"><div class="legend-color" style="background: rgb(245, 237, 0);"></div>BA / Admin</div><div class="legend-clear">Clear Filter</div><h3 style="margin-top: 10px;">Process Types</h3><div class="legend-item" data-process-type="process"><svg viewBox="0 0 12 12" style="width: 20px; height: 20px; flex-shrink: 0;"><rect x="1.5" y="1.5" width="9" height="9" rx="2" fill="none" stroke="#94a3b8" stroke-width="0.8"></rect></svg>Process</div><div class="legend-item" data-process-type="document"><svg viewBox="0 0 12 12" style="width: 20px; height: 20px; flex-shrink: 0;"><rect x="1.5" y="1.5" width="9" height="9" rx="2" fill="none" stroke="#94a3b8" stroke-width="0.8" stroke-dasharray="2,1.5"></rect></svg>Document</div><div class="legend-item" data-process-type="outside-process"><svg viewBox="0 0 12 12" style="width: 20px; height: 20px; flex-shrink: 0;"><circle cx="6" cy="6" r="4.5" fill="none" stroke="#94a3b8" stroke-width="0.8"></circle></svg>Outside Process</div><div class="legend-item" data-process-type="process-tbd"><svg viewBox="0 0 12 12" style="width: 20px; height: 20px; flex-shrink: 0;"><circle cx="6" cy="6" r="4.5" fill="none" stroke="#94a3b8" stroke-width="0.8" stroke-dasharray="2,1.5"></circle></svg>Process to be developed</div><div class="legend-item" data-process-type="queue"><svg viewBox="0 0 12 12" style="width: 20px; height: 20px; flex-shrink: 0;"><polygon points="1.5,1.5 10.5,1.5 6,10.5" fill="none" stroke="#94a3b8" stroke-width="0.8"></polygon></svg>Queue or Wait Period</div><div class="legend-item" data-process-type="corporate-accounting"><svg viewBox="0 0 12 12" style="width: 20px; height: 20px; flex-shrink: 0;"><polygon points="3,1.5 9,1.5 11.5,6 9,10.5 3,10.5 0.5,6" fill="none" stroke="#94a3b8" stroke-width="0.8"></polygon></svg>Process: Corporate Accounting Mandatory</div><div class="legend-item" data-process-type="records-management"><svg viewBox="0 0 12 12" style="width: 20px; height: 20px; flex-shrink: 0;"><polygon points="3,1.5 9,1.5 11.5,6 9,10.5 3,10.5 0.5,6" fill="none" stroke="#94a3b8" stroke-width="0.8" stroke-dasharray="2,1.5"></polygon></svg>Process: Records Management Protocol</div><div class="legend-item" data-process-type="decision"><svg viewBox="0 0 12 12" style="width: 20px; height: 20px; flex-shrink: 0;"><polygon points="6,1.5 10.5,6 6,10.5 1.5,6" fill="none" stroke="#94a3b8" stroke-width="0.8"></polygon></svg>Decision</div></div>

    <!-- Side Panel for Detailed Information -->
    <div id="sidepanel" class="">
        <button class="close-btn" onclick="closeSidePanel()">√ó</button>
        <div id="panel-content"><h2>7. Inspections</h2><span class="role-badge" style="background: rgb(42, 141, 203);">Post Award</span><p class="description">-Initial-within 10 days
- Progress based on Risk Rating, minimum 1/month</p><div class="section"><h3>Connected Activities (3)</h3><div class="connection-item"><div class="connection-dot" style="background: rgb(42, 141, 203);"></div><span>6. Harvest Start and Road Construction Start</span></div><div class="connection-item"><div class="connection-dot" style="background: rgb(24, 192, 12);"></div><span>7a. HARV CONFM TECH</span></div><div class="connection-item"><div class="connection-dot" style="background: rgb(145, 114, 33);"></div><span>8a. Change of Plan Requested</span></div></div><div class="section"><h3>Process Type</h3><p>Process: Records Management Protocol</p></div></div>
    </div>

    

    <div id="controls">
        <button onclick="zoomIn()">Zoom In (+)</button>
        <button onclick="zoomOut()">Zoom Out (-)</button>
        <button onclick="resetView()">Reset View</button>
        <button onclick="clearSelection()">Clear Selection</button>
        <div class="zoom-info">Scroll to zoom | Drag to pan</div>
    </div>

    <div class="instructions">
        Click activities to see connections and details | Click legend roles to filter | Use drag mode to reposition nodes |
        Edit mode: double-click to add, click two nodes to connect, right-click to edit/delete
    </div>

    <div id="tooltip" class="" style="left: 323px; top: 357px;">
        <h4>POST AWARD OUTSTANDING OBLIGATIONS PROCESS</h4>
        <p></p>
        <span class="role" style="background: rgb(42, 141, 203);">Post Award</span>
    </div>

    <!-- Nav Links Panel -->
    <div id="nav-links-panel" class="hidden"></div>

    <!-- Annotation Context Menu -->
    <div id="annotation-context-menu" style="display: none;"></div>

    <div id="canvas" style="cursor: grab;" class=""></div>

    <script>
        // Storage key for localStorage
        const STORAGE_KEY = 'planopoly-workflow-data';

        // State management
        let isDragMode = false;
        let isEditMode = false;
        let selectedRole = null;
        let selectedProcessType = null;
        let selectedNode = null;
        let linkSourceNode = null; // For creating connections
        let isLightMode = true;
        let editingNodeId = null; // For modal
        let editingLink = null; // For link editor popover

        // Nav links
        let navLinks = [];
        const defaultNavLinks = [];

        // Annotations
        let annotations = [];
        const defaultAnnotations = [];
        let nextAnnotationId = 1;
        let currentDrawTool = 'none';
        let selectedAnnotation = null;
        let drawingAnnotation = null; // in-progress annotation during drag-create

        // State variables
        let nodeWidth = 130;
        let nodeHeight = 40;
        let linkOpacity = 0.4;
        let defaultZoomLevel = 0.49306482786689093;
        let defaultPanX = 218.49062963909716;
        let defaultPanY = 71.90456815797398;

        // Per-node dimension helpers (fall back to global defaults)
        function getNodeW(node) { return node.width || nodeWidth; }
        function getNodeH(node) { return node.height || nodeHeight; }

        // Category labels (user-customizable)
        let roleCategoryLabel = 'Responsibility or Process Description';
        let processTypeCategoryLabel = 'Process Types';

        // Role colors
        let roleColors = {
    "Engineering": "#c7c2c2",
    "Silviculture": "#eb0acd",
    "Post Award": "#2a8dcb",
    "LRM or Other Corp. Systems": "#18c00c",
    "Communication Point": "#917221",
    "BA / Admin": "#f5ed00"
};

        // Process types config
        let processTypes = {
    "process": {
        "label": "Process",
        "shape": "rect",
        "dashed": false
    },
    "document": {
        "label": "Document",
        "shape": "rect",
        "dashed": true
    },
    "outside-process": {
        "label": "Outside Process",
        "shape": "circle",
        "dashed": false
    },
    "process-tbd": {
        "label": "Process to be developed",
        "shape": "circle",
        "dashed": true
    },
    "queue": {
        "label": "Queue or Wait Period",
        "shape": "triangle",
        "dashed": false
    },
    "corporate-accounting": {
        "label": "Process: Corporate Accounting Mandatory",
        "shape": "hexagon",
        "dashed": false
    },
    "records-management": {
        "label": "Process: Records Management Protocol",
        "shape": "hexagon",
        "dashed": true
    },
    "decision": {
        "label": "Decision",
        "shape": "diamond",
        "dashed": false
    }
};

        // Fixed link color
        const linkColor = '#6b7280';

        // Configuration constants
        const CONFIG = {
            SVG_WIDTH: 1900,
            SVG_HEIGHT: 600,
            ZOOM_SCALE_EXTENT: [0.3, 3],
            BEZIER_OFFSET: { factor: 0.4, min: 30, max: 120 },
            LINK_EDITOR: { width: 220, height: 100 },
            NODE_FONT_SIZE: 11,
            DASHED_STROKE: '6,3',
            ARROW_MARKER_SIZE: 8,
            THROTTLE_DELAY: 16.6, // 60fps
            MESSAGES: {
                SAVED: 'Data saved to browser storage!',
                LOADED: 'Data loaded!',
                RESET: 'Data reset to defaults',
                EXPORT_SUCCESS: 'HTML file downloaded!'
            }
        };

        // Utility functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function throttle(func, delay) {
            let lastCall = 0;
            return function(...args) {
                const now = Date.now();
                if (now - lastCall >= delay) {
                    lastCall = now;
                    return func.apply(this, args);
                }
            };
        }

        function safeLoadFromStorage(key, defaultValue) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                console.warn(`Failed to load ${key} from storage:`, e);
                return defaultValue;
            }
        }

        function safeSaveToStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (e) {
                console.error(`Failed to save ${key} to storage:`, e);
                return false;
            }
        }

        // Default nodes data
        const defaultNodes = [
    {
        "id": 1,
        "name": "START       Post Award Process",
        "role": "LRM or Other Corp. Systems",
        "processType": "process",
        "x": -50.48802185058594,
        "y": 73.76710510253906,
        "desc": "Starting point",
        "resources": [],
        "width": 120,
        "height": 40
    },
    {
        "id": 2,
        "name": "0.  TSL (& RP) Issued",
        "role": "BA / Admin",
        "processType": "process",
        "x": 108,
        "y": 74,
        "desc": "Signed TSL Documents sent to Licensee & HARV CONFM TECH",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 3,
        "name": "1. Request for Pre-Work Licensee",
        "role": "Communication Point",
        "processType": "queue",
        "x": 261.44415283203125,
        "y": 76.0801773071289,
        "desc": "",
        "resources": [],
        "width": 120,
        "height": 60
    },
    {
        "id": 13,
        "name": "2. HARV CONFRM TECH",
        "role": "Post Award",
        "processType": "document",
        "x": 420.4826965332031,
        "y": 73.53783416748047,
        "desc": "Document Results of Risk Assessment on Pre-work Form CHK-01R",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 15,
        "name": "3. TSL (& RP) Pre-Work",
        "role": "Post Award",
        "processType": "records-management",
        "x": 587.3886108398438,
        "y": 72.83027648925781,
        "desc": "CHK-003 Include ET in PW if significant road",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 20,
        "name": "4. RUP in Place?",
        "role": "Post Award",
        "processType": "decision",
        "x": 743.5457763671875,
        "y": 72.9834213256836,
        "desc": "",
        "resources": [],
        "width": null,
        "height": 40
    },
    {
        "id": 46,
        "name": "Waste & Residue",
        "role": "Post Award",
        "processType": "outside-process",
        "x": 586.8965144622557,
        "y": -21.146292221237942,
        "desc": "Contract Process",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 47,
        "name": "3a. HARV CONFM TECH",
        "role": "Communication Point",
        "processType": "process",
        "x": 588.0143667415848,
        "y": 156.5581507829406,
        "desc": "If Cruise-Based, Review Billing Process with Licensee (Must be Reported to HBS by the 7th of each Month)",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 48,
        "name": "No",
        "role": "Post Award",
        "processType": "decision",
        "x": 743.2526613768396,
        "y": 143.4146592982786,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 49,
        "name": "YES",
        "role": "Post Award",
        "processType": "decision",
        "x": 847.5974850312858,
        "y": 78.21397825218058,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 50,
        "name": "4a. RUP Required",
        "role": "Post Award",
        "processType": "process",
        "x": 744.1614291499297,
        "y": 216.86504267205862,
        "desc": "Confirm in place with Licensee prior to start",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 51,
        "name": "5. >90 Days Since Pre-work?",
        "role": "Post Award",
        "processType": "decision",
        "x": 955.054627166618,
        "y": 62.95928122527144,
        "desc": "",
        "resources": [],
        "width": null,
        "height": 60
    },
    {
        "id": 52,
        "name": "NO",
        "role": "Post Award",
        "processType": "decision",
        "x": 1067.544794203444,
        "y": 77.9805436202031,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 53,
        "name": "YES",
        "role": "Post Award",
        "processType": "decision",
        "x": 955.1200748738767,
        "y": 146.55395550148216,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 54,
        "name": "5a. HARV CONFM TECH",
        "role": "Post Award",
        "processType": "records-management",
        "x": 1067.5447704598946,
        "y": 140.76377346143465,
        "desc": "Reviews; New Pre-work Req‚Äôd Then Proceed",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 55,
        "name": "External Communication Process with Licensee",
        "role": "Communication Point",
        "processType": "outside-process",
        "x": 882.4447114408975,
        "y": -36.33108520608836,
        "desc": "",
        "resources": [],
        "width": 60,
        "height": 60
    },
    {
        "id": 56,
        "name": "6. Harvest Start and Road Construction Start",
        "role": "Post Award",
        "processType": "process",
        "x": 1215.421638816729,
        "y": 72.73875703126745,
        "desc": "",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 57,
        "name": "6b. HARV CONFM TECH",
        "role": "LRM or Other Corp. Systems",
        "processType": "corporate-accounting",
        "x": 1214.476430676693,
        "y": -71.56752375567453,
        "desc": "LRM Update Block Activity Logging Started (LS) Block Details/State = ADV to HB (Logging Started)",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 58,
        "name": "6a. HARV CONFM TECH",
        "role": "Communication Point",
        "processType": "process",
        "x": 1214.833938231526,
        "y": -0.19157440655350655,
        "desc": "Notify Silviculture Tech, Eng Tech PLF & C&E",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 59,
        "name": "6c. HARV CONFM TECH",
        "role": "LRM or Other Corp. Systems",
        "processType": "corporate-accounting",
        "x": 1216.2324537303377,
        "y": 142.4309173272657,
        "desc": "Road Permit & Schedule C: Construct Start Date",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 60,
        "name": "6d. HARV CONFM TECH",
        "role": "LRM or Other Corp. Systems",
        "processType": "process",
        "x": 1216.232393187165,
        "y": 209.54737681343374,
        "desc": "EMS-LRM Pre-work (Toggle Certification Tab: Licence Level);",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 61,
        "name": "7. Inspections",
        "role": "Post Award",
        "processType": "records-management",
        "x": 1381.74236043248,
        "y": 71.7084357054765,
        "desc": "-Initial-within 10 days\n- Progress based on Risk Rating, minimum 1/month",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 62,
        "name": "7a. HARV CONFM TECH",
        "role": "LRM or Other Corp. Systems",
        "processType": "process",
        "x": 1381.742266197169,
        "y": -1.7857444741722652,
        "desc": "Updates LRM with Inspection Dates",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 63,
        "name": "8a. Change of Plan Requested",
        "role": "Communication Point",
        "processType": "decision",
        "x": 1542.8041475526081,
        "y": 51.38027873455155,
        "desc": "",
        "resources": [],
        "width": 130,
        "height": 80
    },
    {
        "id": 64,
        "name": "YES",
        "role": "Communication Point",
        "processType": "decision",
        "x": 1542.8039918198263,
        "y": -5.634256306194288,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 65,
        "name": "NO",
        "role": "Communication Point",
        "processType": "decision",
        "x": 1644.4448024889082,
        "y": 76.39955259354963,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 66,
        "name": "8a. Change of Plan",
        "role": "Post Award",
        "processType": "decision",
        "x": 1542.8401371423167,
        "y": -73.03003521518713,
        "desc": "Proposal meets legal requirements",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 67,
        "name": "8b. Change of Plan Accepted",
        "role": "Post Award",
        "processType": "records-management",
        "x": 1543.3605227303055,
        "y": -150.6520751954951,
        "desc": "TSL Proceeds accordingly",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 68,
        "name": "8c. Plan Rejected ",
        "role": "Post Award",
        "processType": "process",
        "x": 1706.3123563981326,
        "y": -73.02287477555132,
        "desc": "Plan Returned to Licensee for Changes & Re-submission",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 69,
        "name": "9b. CSO Document issue in EMS",
        "role": "LRM or Other Corp. Systems",
        "processType": "outside-process",
        "x": 1640.168924470509,
        "y": 219.57835473672117,
        "desc": "",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 70,
        "name": "9. In Conformance / Compliance?",
        "role": "Post Award",
        "processType": "process-tbd",
        "x": 1769.1076637574076,
        "y": 219.89723047338745,
        "desc": "",
        "resources": [],
        "width": 40,
        "height": 40
    },
    {
        "id": 71,
        "name": "9a. Conformance / Compliance Process",
        "role": "Post Award",
        "processType": "records-management",
        "x": 1769.1076214973589,
        "y": 71.50486266348165,
        "desc": "",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 73,
        "name": "NO",
        "role": "Post Award",
        "processType": "decision",
        "x": 1769.1075217626096,
        "y": 140.81639040610747,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 74,
        "name": "YES",
        "role": "Post Award",
        "processType": "decision",
        "x": 1866.055415489026,
        "y": 76.25718089284622,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 75,
        "name": "10a. Licensee",
        "role": "Communication Point",
        "processType": "outside-process",
        "x": 1997.7222810055102,
        "y": -62.285482132781254,
        "desc": "Notification re: Shutdown & Start-up",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 76,
        "name": "10a. Operations / Shutdown - Interruption > 90 Days?",
        "role": "Post Award",
        "processType": "decision",
        "x": 1998.2904118185204,
        "y": 49.78523243542581,
        "desc": "",
        "resources": [],
        "width": 190,
        "height": 80
    },
    {
        "id": 77,
        "name": "Go to Step 5",
        "role": "Post Award",
        "processType": "process",
        "x": 2228.095082602009,
        "y": 69.63053794733696,
        "desc": "",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 78,
        "name": "YES",
        "role": "Post Award",
        "processType": "decision",
        "x": 2128.376890695512,
        "y": 74.71819066402324,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 79,
        "name": "NO",
        "role": "Post Award",
        "processType": "decision",
        "x": 1998.132873923661,
        "y": 155.10328003880431,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 80,
        "name": "12. HARV CONFM TECH",
        "role": "Communication Point",
        "processType": "document",
        "x": 1997.2099852128918,
        "y": 305.1887817348019,
        "desc": "Receives notification from Licensee;\nLogging Complete (LC) on all blocks",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 81,
        "name": "13. Licensee Submits Completion Form",
        "role": "Post Award",
        "processType": "records-management",
        "x": 1996.4268314057765,
        "y": 389.24185559197684,
        "desc": "- Licensee submits ‚ÄúTSL Harvest Completion & Deposit Release Form‚Äù with Harvest Complete.\n- HARV CONFM TECH completes Final\nInspection & confirms LC and outstanding obligations.",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 82,
        "name": "11. HARV CONFM TECH",
        "role": "Post Award",
        "processType": "records-management",
        "x": 1998.1194828192706,
        "y": 227.59542800637755,
        "desc": "Continues with inspections until LC",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 83,
        "name": "14. Primary Logging Complete",
        "role": "Post Award",
        "processType": "decision",
        "x": 1835.452370538944,
        "y": 379.37317479605196,
        "desc": "",
        "resources": [],
        "width": 120,
        "height": 60
    },
    {
        "id": 84,
        "name": "NO",
        "role": "Post Award",
        "processType": "decision",
        "x": 1847.9210292819728,
        "y": 232.53700729862248,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 85,
        "name": "15. HARV CONFM TECH",
        "role": "LRM or Other Corp. Systems",
        "processType": "process",
        "x": 1583.2627646904864,
        "y": 389.1101624811349,
        "desc": "- LRM Logging Complete Entry\n\n- LC- Block Activity Tab (All wood felled & skid to roadside or landing)\n\n- SC-Substantial completion LRM\ntoggle at License Activity level (only if all blocks are LC)",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 86,
        "name": "15a. HARV CONFM TECH",
        "role": "Post Award",
        "processType": "process",
        "x": 1583.7897488447097,
        "y": 468.94098490738145,
        "desc": "Updates FTA from LS to LC to ensure Licensee 3 TSL Limit status is presented as appropriate",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 87,
        "name": "YES",
        "role": "Post Award",
        "processType": "decision",
        "x": 1712.269928986621,
        "y": 394.5024277346663,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 88,
        "name": "16. HARV CONFM TECH",
        "role": "Post Award",
        "processType": "records-management",
        "x": 1404.8978620593748,
        "y": 388.75765194337225,
        "desc": "Outstanding Obligations Letter to Licensee",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 89,
        "name": "17. Has there been a Change of Plan resulting in a Change of Circumstance or Amendment that required documentation? Blocks or Roads?",
        "role": "Post Award",
        "processType": "decision",
        "x": 1134.2913809236231,
        "y": 348.4368099117,
        "desc": "",
        "resources": [],
        "width": 330,
        "height": 120
    },
    {
        "id": 90,
        "name": "Change of Circumstance Process & Calculator",
        "role": "Post Award",
        "processType": "outside-process",
        "x": 1063.9244316210822,
        "y": 611.7021451025907,
        "desc": "",
        "resources": [],
        "width": 60,
        "height": 60
    },
    {
        "id": 91,
        "name": "Site Plan Amendment Process",
        "role": "Post Award",
        "processType": "outside-process",
        "x": 1205.5346174732979,
        "y": 613.2114923788093,
        "desc": "",
        "resources": [],
        "width": 60,
        "height": 60
    },
    {
        "id": 92,
        "name": "YES",
        "role": "Post Award",
        "processType": "decision",
        "x": 1204.3200290970271,
        "y": 503.89936783306314,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 93,
        "name": "YES",
        "role": "Post Award",
        "processType": "decision",
        "x": 1063.4288174589506,
        "y": 505.11390117399276,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 94,
        "name": "17a. HARV CONFM TECH",
        "role": "LRM or Other Corp. Systems",
        "processType": "corporate-accounting",
        "x": 1063.42890204069,
        "y": 750.4588761576705,
        "desc": "LRM\nToggle Change of Circumstance\nYES",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 95,
        "name": "NO",
        "role": "Post Award",
        "processType": "decision",
        "x": 897.031584009472,
        "y": 394.58733414496885,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 96,
        "name": "18. HARV CONFM TECH LRM",
        "role": "LRM or Other Corp. Systems",
        "processType": "corporate-accounting",
        "x": 774.8466194927987,
        "y": 389.2131102506429,
        "desc": "LRM Change of Circumstance ‚Äì NO = toggle N/A",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 97,
        "name": "19. HARV CONFM TECH",
        "role": "Communication Point",
        "processType": "process",
        "x": 595.5883278952081,
        "y": 389.21311929913054,
        "desc": "Notify Silviculture - Harvest Complete",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 98,
        "name": "19a. HARV CONFM TECH",
        "role": "LRM or Other Corp. Systems",
        "processType": "corporate-accounting",
        "x": 595.588301557246,
        "y": 283.8988766379881,
        "desc": "Completes Harvest Depletion and submits to RESULTS by not later than May 31 annually.",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 99,
        "name": "POST AWARD OUTSTANDING OBLIGATIONS PROCESS",
        "role": "Post Award",
        "processType": "outside-process",
        "x": 389.4412399702933,
        "y": 369.04654562515566,
        "desc": "",
        "resources": [],
        "width": 80,
        "height": 80
    },
    {
        "id": 100,
        "name": "20b. HARV CONFM TECH",
        "role": "LRM or Other Corp. Systems",
        "processType": "corporate-accounting",
        "x": 181.2314521098391,
        "y": 195.44131733283075,
        "desc": "Timber Mark Activity: Balance Cruise Based Harvest Vol.in HBS",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 101,
        "name": "20a. HARV CONFM TECH LRM",
        "role": "LRM or Other Corp. Systems",
        "processType": "corporate-accounting",
        "x": 181.40937913546168,
        "y": 288.8835001338924,
        "desc": "LRM - Enter ‚ÄúChange of Circumstance Record Post-award‚Äù record",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 102,
        "name": "20. HARV CONFM TECH",
        "role": "LRM or Other Corp. Systems",
        "processType": "corporate-accounting",
        "x": 180.12091656678348,
        "y": 389.52940657042166,
        "desc": "Update Activities (Roads and Blocks) Update Deactivation Dates for Road Permit & Schedule C Roads",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 103,
        "name": "21b. BA Processes 45D",
        "role": "BA / Admin",
        "processType": "records-management",
        "x": -13.763145629105338,
        "y": 192.92208513427647,
        "desc": "Close File Process, Retire RP",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 104,
        "name": "21a. BA LRM Update",
        "role": "LRM or Other Corp. Systems",
        "processType": "corporate-accounting",
        "x": -13.763129266195364,
        "y": 291.43510896807805,
        "desc": "BA LRM Update Activities License Activity: License Closed = Done License State = HC",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 105,
        "name": "21. Final Deposit Release",
        "role": "Post Award",
        "processType": "process",
        "x": -12.003928793948518,
        "y": 389.94812069214277,
        "desc": "",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 106,
        "name": "Silviculture Process",
        "role": "Silviculture",
        "processType": "outside-process",
        "x": -193.19748093824848,
        "y": 389.94810141034816,
        "desc": "",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 107,
        "name": "13a. HARV CONFM TECH",
        "role": "LRM or Other Corp. Systems",
        "processType": "process",
        "x": 1995.4480549225088,
        "y": 522.6351586504235,
        "desc": "Inputs Final Harvest Inspection into LRM Certification Tab",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 108,
        "name": "13b. HARV CONFM TECH",
        "role": "Communication Point",
        "processType": "records-management",
        "x": 1994.2191218339321,
        "y": 648.0038811462539,
        "desc": "Advises ET Logging/Road Construction Complete Provides Tenure Disposal Form",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 109,
        "name": "13c. ET completes inspection",
        "role": "Engineering",
        "processType": "process",
        "x": 1994.218961631314,
        "y": 765.9978232828803,
        "desc": "Notifies HARV CONFM TECH if any quality or conformance issues observed",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 110,
        "name": "13d. ET completes Tenure Disposal Form",
        "role": "Engineering",
        "processType": "records-management",
        "x": 1997.9061177858134,
        "y": 881.533706115935,
        "desc": "New node description",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 111,
        "name": "Tenure DELETION Process",
        "role": "Engineering",
        "processType": "outside-process",
        "x": 1814.7697756612545,
        "y": 699.6262497710103,
        "desc": "",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 112,
        "name": "13e. Is Tenure Retired?",
        "role": "Post Award",
        "processType": "decision",
        "x": 1815.9986308293646,
        "y": 876.6173352066443,
        "desc": "Follow DELETION Process",
        "resources": [],
        "width": 110,
        "height": 80
    },
    {
        "id": 113,
        "name": "YES",
        "role": "Post Award",
        "processType": "decision",
        "x": 1815.998847824461,
        "y": 799.1837001063653,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 114,
        "name": "NO",
        "role": "Post Award",
        "processType": "decision",
        "x": 1699.1063783504592,
        "y": 901.7096420623204,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 115,
        "name": "13f. Is Tenure to be TRANSFERRED?",
        "role": "Post Award",
        "processType": "decision",
        "x": 1559.39680652086,
        "y": 876.514054693746,
        "desc": "Follow Transfer Process",
        "resources": [],
        "width": 140,
        "height": 80
    },
    {
        "id": 116,
        "name": "YES",
        "role": "Post Award",
        "processType": "decision",
        "x": 1424.3507547640977,
        "y": 902.455144999928,
        "desc": "",
        "resources": [],
        "width": 30,
        "height": 30
    },
    {
        "id": 117,
        "name": "Tenure TRANSFER Process",
        "role": "Engineering",
        "processType": "outside-process",
        "x": 1306.8528902181436,
        "y": 897.8772357775089,
        "desc": "",
        "resources": [],
        "width": null,
        "height": null
    },
    {
        "id": 118,
        "name": "Engineering Inspection- Maintenance- Deactivation Process",
        "role": "Engineering",
        "processType": "outside-process",
        "x": 1121.4506488335471,
        "y": 882.6176741073118,
        "desc": "",
        "resources": [],
        "width": 70,
        "height": 70
    }
];
        // Default links
        const defaultLinks = [
    {
        "source": 1,
        "target": 2,
        "arrowMode": "forward"
    },
    {
        "source": 2,
        "target": 3,
        "arrowMode": "forward"
    },
    {
        "source": 3,
        "target": 13,
        "arrowMode": "forward"
    },
    {
        "source": 13,
        "target": 15,
        "arrowMode": "forward"
    },
    {
        "source": 15,
        "target": 20,
        "arrowMode": "forward"
    },
    {
        "source": 47,
        "target": 15,
        "arrowMode": "reverse"
    },
    {
        "source": 54,
        "target": 52,
        "arrowMode": "forward"
    },
    {
        "source": 53,
        "target": 54,
        "arrowMode": "forward"
    },
    {
        "source": 51,
        "target": 53,
        "arrowMode": "forward"
    },
    {
        "source": 51,
        "target": 52,
        "arrowMode": "forward"
    },
    {
        "source": 20,
        "target": 49,
        "arrowMode": "forward"
    },
    {
        "source": 49,
        "target": 51,
        "arrowMode": "forward"
    },
    {
        "source": 20,
        "target": 48,
        "arrowMode": "forward"
    },
    {
        "source": 48,
        "target": 50,
        "arrowMode": "forward"
    },
    {
        "source": 60,
        "target": 59,
        "arrowMode": "forward"
    },
    {
        "source": 59,
        "target": 56,
        "arrowMode": "forward"
    },
    {
        "source": 56,
        "target": 58,
        "arrowMode": "reverse"
    },
    {
        "source": 58,
        "target": 57,
        "arrowMode": "reverse"
    },
    {
        "source": 52,
        "target": 56,
        "arrowMode": "forward"
    },
    {
        "source": 56,
        "target": 61,
        "arrowMode": "forward"
    },
    {
        "source": 61,
        "target": 62,
        "arrowMode": "forward"
    },
    {
        "source": 61,
        "target": 63,
        "arrowMode": "none"
    },
    {
        "source": 63,
        "target": 64,
        "arrowMode": "forward"
    },
    {
        "source": 63,
        "target": 65,
        "arrowMode": "forward"
    },
    {
        "source": 69,
        "target": 65,
        "arrowMode": "none"
    },
    {
        "source": 69,
        "target": 70,
        "arrowMode": "reverse"
    },
    {
        "source": 70,
        "target": 73,
        "arrowMode": "reverse"
    },
    {
        "source": 73,
        "target": 71,
        "arrowMode": "reverse"
    },
    {
        "source": 65,
        "target": 71,
        "arrowMode": "forward"
    },
    {
        "source": 71,
        "target": 74,
        "arrowMode": "forward"
    },
    {
        "source": 66,
        "target": 64,
        "arrowMode": "reverse"
    },
    {
        "source": 66,
        "target": 67,
        "arrowMode": "forward"
    },
    {
        "source": 66,
        "target": 68,
        "arrowMode": "forward"
    },
    {
        "source": 74,
        "target": 76,
        "arrowMode": "forward"
    },
    {
        "source": 76,
        "target": 75,
        "arrowMode": "reverse"
    },
    {
        "source": 76,
        "target": 78,
        "arrowMode": "forward"
    },
    {
        "source": 78,
        "target": 77,
        "arrowMode": "forward"
    },
    {
        "source": 76,
        "target": 79,
        "arrowMode": "forward"
    },
    {
        "source": 79,
        "target": 82,
        "arrowMode": "forward"
    },
    {
        "source": 82,
        "target": 80,
        "arrowMode": "forward"
    },
    {
        "source": 80,
        "target": 81,
        "arrowMode": "forward"
    },
    {
        "source": 81,
        "target": 83,
        "arrowMode": "forward"
    },
    {
        "source": 83,
        "target": 84,
        "arrowMode": "forward"
    },
    {
        "source": 84,
        "target": 82,
        "arrowMode": "forward"
    },
    {
        "source": 85,
        "target": 86,
        "arrowMode": "forward"
    },
    {
        "source": 85,
        "target": 88,
        "arrowMode": "forward"
    },
    {
        "source": 83,
        "target": 87,
        "arrowMode": "forward"
    },
    {
        "source": 87,
        "target": 85,
        "arrowMode": "forward"
    },
    {
        "source": 88,
        "target": 89,
        "arrowMode": "forward"
    },
    {
        "source": 89,
        "target": 93,
        "arrowMode": "forward"
    },
    {
        "source": 89,
        "target": 92,
        "arrowMode": "forward"
    },
    {
        "source": 92,
        "target": 91,
        "arrowMode": "forward"
    },
    {
        "source": 93,
        "target": 90,
        "arrowMode": "forward"
    },
    {
        "source": 90,
        "target": 94,
        "arrowMode": "forward"
    },
    {
        "source": 89,
        "target": 95,
        "arrowMode": "forward"
    },
    {
        "source": 95,
        "target": 96,
        "arrowMode": "forward"
    },
    {
        "source": 96,
        "target": 97,
        "arrowMode": "forward"
    },
    {
        "source": 97,
        "target": 98,
        "arrowMode": "forward"
    },
    {
        "source": 97,
        "target": 99,
        "arrowMode": "forward"
    },
    {
        "source": 99,
        "target": 102,
        "arrowMode": "forward"
    },
    {
        "source": 102,
        "target": 101,
        "arrowMode": "forward"
    },
    {
        "source": 101,
        "target": 100,
        "arrowMode": "forward"
    },
    {
        "source": 102,
        "target": 105,
        "arrowMode": "forward"
    },
    {
        "source": 105,
        "target": 104,
        "arrowMode": "forward"
    },
    {
        "source": 104,
        "target": 103,
        "arrowMode": "forward"
    },
    {
        "source": 105,
        "target": 106,
        "arrowMode": "forward"
    },
    {
        "source": 81,
        "target": 107,
        "arrowMode": "forward"
    },
    {
        "source": 107,
        "target": 108,
        "arrowMode": "forward"
    },
    {
        "source": 108,
        "target": 109,
        "arrowMode": "forward"
    },
    {
        "source": 109,
        "target": 110,
        "arrowMode": "forward"
    },
    {
        "source": 110,
        "target": 112,
        "arrowMode": "forward"
    },
    {
        "source": 112,
        "target": 113,
        "arrowMode": "forward"
    },
    {
        "source": 113,
        "target": 111,
        "arrowMode": "forward"
    },
    {
        "source": 112,
        "target": 114,
        "arrowMode": "forward"
    },
    {
        "source": 114,
        "target": 115,
        "arrowMode": "forward"
    },
    {
        "source": 115,
        "target": 116,
        "arrowMode": "forward"
    },
    {
        "source": 116,
        "target": 117,
        "arrowMode": "forward"
    },
    {
        "source": 117,
        "target": 118,
        "arrowMode": "forward"
    }
];

        // Working data (will be loaded from localStorage or defaults)
        let nodes = [];
        let links = [];

        // Node map and adjacency
        let nodeMap = new Map();
        let adjacency = new Map();

        function rebuildMaps() {
            nodeMap = new Map(nodes.map(n => [n.id, n]));
            adjacency = new Map();
            nodes.forEach(n => adjacency.set(n.id, new Set()));
            links.forEach(l => {
                if (adjacency.has(l.source) && adjacency.has(l.target)) {
                    adjacency.get(l.source).add(l.target);
                    adjacency.get(l.target).add(l.source);
                }
            });
        }

        // Smart text splitting for multi-line node labels
        function splitTextSmart(text, maxLines = 3) {
            const words = text.split(' ');
            if (words.length === 1) {
                return [text];
            }
            if (words.length === 2) {
                return words;
            }
            const totalLength = text.length;
            const targetLineLength = totalLength / Math.min(words.length, maxLines);
            const lines = [];
            let currentLine = '';
            for (const word of words) {
                if (lines.length >= maxLines - 1) {
                    currentLine = currentLine ? currentLine + ' ' + word : word;
                } else if (!currentLine) {
                    currentLine = word;
                } else if ((currentLine + ' ' + word).length <= targetLineLength + 4) {
                    currentLine += ' ' + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            if (currentLine) {
                lines.push(currentLine);
            }
            return lines;
        }

        // SVG Setup
        const width = CONFIG.SVG_WIDTH;
        const height = CONFIG.SVG_HEIGHT;

        const svg = d3.select('#canvas')
            .append('svg')
            .attr('viewBox', `0 0 ${width} ${height}`)
            .attr('preserveAspectRatio', 'xMidYMid meet');

        const g = svg.append('g');

        // Arrow marker definitions for connection lines
        const defs = svg.append('defs');

        // Forward arrow (at target end)
        defs.append('marker')
            .attr('id', 'arrow-forward')
            .attr('viewBox', '0 0 8 8')
            .attr('refX', 8).attr('refY', 4)
            .attr('markerWidth', 8).attr('markerHeight', 8)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M 0,0 L 8,4 L 0,8 Z')
            .attr('fill', linkColor);

        // Reverse arrow (at source end) ‚Äî points opposite direction
        defs.append('marker')
            .attr('id', 'arrow-reverse')
            .attr('viewBox', '0 0 8 8')
            .attr('refX', 0).attr('refY', 4)
            .attr('markerWidth', 8).attr('markerHeight', 8)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M 8,0 L 0,4 L 8,8 Z')
            .attr('fill', linkColor);

        // Highlighted forward arrow
        defs.append('marker')
            .attr('id', 'arrow-forward-highlighted')
            .attr('viewBox', '0 0 10 10')
            .attr('refX', 10).attr('refY', 5)
            .attr('markerWidth', 10).attr('markerHeight', 10)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M 0,0 L 10,5 L 0,10 Z')
            .attr('fill', '#94a3b8');

        // Highlighted reverse arrow
        defs.append('marker')
            .attr('id', 'arrow-reverse-highlighted')
            .attr('viewBox', '0 0 10 10')
            .attr('refX', 0).attr('refY', 5)
            .attr('markerWidth', 10).attr('markerHeight', 10)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M 10,0 L 0,5 L 10,10 Z')
            .attr('fill', '#94a3b8');

        // Dimmed forward arrow
        defs.append('marker')
            .attr('id', 'arrow-forward-dimmed')
            .attr('viewBox', '0 0 8 8')
            .attr('refX', 8).attr('refY', 4)
            .attr('markerWidth', 8).attr('markerHeight', 8)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M 0,0 L 8,4 L 0,8 Z')
            .attr('fill', linkColor)
            .attr('opacity', 0.15);

        // Dimmed reverse arrow
        defs.append('marker')
            .attr('id', 'arrow-reverse-dimmed')
            .attr('viewBox', '0 0 8 8')
            .attr('refX', 0).attr('refY', 4)
            .attr('markerWidth', 8).attr('markerHeight', 8)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M 8,0 L 0,4 L 8,8 Z')
            .attr('fill', linkColor)
            .attr('opacity', 0.15);

        // Temporary link line for creating connections
        const tempLinkLine = g.append('line')
            .attr('class', 'temp-link')
            .style('display', 'none');

        const zoom = d3.zoom()
            .scaleExtent(CONFIG.ZOOM_SCALE_EXTENT)
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });

        svg.call(zoom);
        svg.on('dblclick.zoom', null);

        // Click/double-click on background
        svg.on('click', (event) => {
            if (event.target === svg.node() || event.target.closest('.annotation-layer')) {
                closeAnnotationContextMenu();
                if (editingLink) {
                    closeLinkEditor();
                    return;
                }
                if (currentDrawTool !== 'none' && currentDrawTool !== 'select') return;
                if (linkSourceNode) {
                    cancelLinkCreation();
                }
                if (currentDrawTool === 'select' && !event.target.closest('.annotation')) {
                    deselectAnnotation();
                }
                clearSelection();
                closeSidePanel();
            }
        });

        svg.on('dblclick', (event) => {
            if (!isEditMode) return;
            if (currentDrawTool !== 'none') return; // suppress node creation in draw mode
            if (event.target !== svg.node()) return;
            event.preventDefault();

            // Get coordinates in SVG space
            const transform = d3.zoomTransform(svg.node());
            const pt = svg.node().createSVGPoint();
            pt.x = event.clientX;
            pt.y = event.clientY;
            const svgP = pt.matrixTransform(svg.node().getScreenCTM().inverse());
            const x = (svgP.x - transform.x) / transform.k;
            const y = (svgP.y - transform.y) / transform.k;

            // Create new node at click position
            createNewNode(x, y);
        });

        // Helper: get SVG coordinates from mouse event
        function getSVGCoords(event) {
            const transform = d3.zoomTransform(svg.node());
            const pt = svg.node().createSVGPoint();
            pt.x = event.clientX;
            pt.y = event.clientY;
            const svgP = pt.matrixTransform(svg.node().getScreenCTM().inverse());
            return {
                x: (svgP.x - transform.x) / transform.k,
                y: (svgP.y - transform.y) / transform.k
            };
        }

        // Mouse move for temp link line + drawing
        svg.on('mousemove', (event) => {
            // Temp link line
            if (linkSourceNode) {
                const { x, y } = getSVGCoords(event);
                const sourceNode = nodeMap.get(linkSourceNode);
                tempLinkLine
                    .attr('x1', sourceNode.x)
                    .attr('y1', sourceNode.y + getNodeH(sourceNode) / 2)
                    .attr('x2', x)
                    .attr('y2', y);
            }

            // Drawing preview
            if (drawingAnnotation) {
                const { x, y } = getSVGCoords(event);
                handleDrawMouseMove(x, y);
            }
        });

        // Mousedown for drawing annotations
        svg.on('mousedown', (event) => {
            if (!isEditMode) return;
            if (currentDrawTool === 'none' || currentDrawTool === 'select') return;
            if (event.target !== svg.node() && !event.target.closest('.annotation-layer')) return;
            if (event.button !== 0) return;

            const { x, y } = getSVGCoords(event);
            handleDrawMouseDown(x, y, event);
        });

        // Mouseup for drawing annotations
        svg.on('mouseup', (event) => {
            if (drawingAnnotation) {
                const { x, y } = getSVGCoords(event);
                handleDrawMouseUp(x, y);
            }
        });

        function initVisualization() {
            // Clear existing
            g.selectAll('.annotation-layer').remove();
            g.selectAll('.link').remove();
            g.selectAll('.node').remove();

            // Annotation layer goes behind links and nodes
            g.append('g').attr('class', 'annotation-layer');

            drawAnnotations();
            drawLinks();
            drawNodes();
        }

        // Anchor calculation cache for performance
        let anchorCache = new Map();

        function clearAnchorCache() {
            anchorCache = new Map();
        }

        function calculateOptimalAnchors(sourceNode, targetNode) {
            // Check cache first
            const cacheKey = `${sourceNode.id}-${targetNode.id}-${sourceNode.x}-${sourceNode.y}-${targetNode.x}-${targetNode.y}`;
            if (anchorCache.has(cacheKey)) {
                return anchorCache.get(cacheKey);
            }

            const sides = ['top', 'bottom', 'left', 'right'];
            let minDistance = Infinity;
            let bestAnchors = { source: 'right', target: 'left' };

            for (const sourceSide of sides) {
                for (const targetSide of sides) {
                    const sourcePoint = getAnchorPoint(sourceNode, sourceSide);
                    const targetPoint = getAnchorPoint(targetNode, targetSide);
                    const distance = Math.hypot(targetPoint.x - sourcePoint.x, targetPoint.y - sourcePoint.y);
                    if (distance < minDistance) {
                        minDistance = distance;
                        bestAnchors = { source: sourceSide, target: targetSide };
                    }
                }
            }

            // Cache the result
            anchorCache.set(cacheKey, bestAnchors);
            return bestAnchors;
        }

        function getAnchorPoint(node, anchor) {
            const w = getNodeW(node);
            const h = getNodeH(node);
            const centerX = node.x;
            const centerY = node.y + h / 2;
            const pt = processTypes[node.processType] || processTypes['process'];

            if (pt.shape === 'circle') {
                // Circle: radius = h, centered at (centerX, centerY)
                const r = h;
                switch(anchor) {
                    case 'top':    return { x: centerX, y: centerY - r };
                    case 'bottom': return { x: centerX, y: centerY + r };
                    case 'left':   return { x: centerX - r, y: centerY };
                    case 'right':  return { x: centerX + r, y: centerY };
                    default:       return { x: centerX + r, y: centerY };
                }
            }

            if (pt.shape === 'triangle') {
                // Triangle: flat top from (centerX - w/2, topY) to (centerX + w/2, topY), point at (centerX, bottomY)
                // At center height, the triangle edge is at ¬±w/4 from centerX
                const topY = node.y;
                const bottomY = node.y + h;
                switch(anchor) {
                    case 'top':    return { x: centerX, y: topY };
                    case 'bottom': return { x: centerX, y: bottomY };
                    case 'left':   return { x: centerX - w/4, y: centerY };
                    case 'right':  return { x: centerX + w/4, y: centerY };
                    default:       return { x: centerX + w/4, y: centerY };
                }
            }

            // Rect, diamond, hexagon: use bounding box
            switch(anchor) {
                case 'top':    return { x: centerX, y: node.y };
                case 'bottom': return { x: centerX, y: node.y + h };
                case 'left':   return { x: centerX - w/2, y: centerY };
                case 'right':  return { x: centerX + w/2, y: centerY };
                default:       return { x: centerX + w/2, y: centerY };
            }
        }

        function getControlPoints(sourcePoint, targetPoint, sourceAnchor, targetAnchor) {
            const dx = targetPoint.x - sourcePoint.x;
            const dy = targetPoint.y - sourcePoint.y;
            let cp1x, cp1y, cp2x, cp2y;
            const baseOffset = Math.min(Math.abs(dx) * CONFIG.BEZIER_OFFSET.factor, Math.abs(dy) * CONFIG.BEZIER_OFFSET.factor, CONFIG.BEZIER_OFFSET.max);
            const offset = Math.max(baseOffset, CONFIG.BEZIER_OFFSET.min);

            switch(sourceAnchor) {
                case 'top': cp1x = sourcePoint.x; cp1y = sourcePoint.y - offset; break;
                case 'bottom': cp1x = sourcePoint.x; cp1y = sourcePoint.y + offset; break;
                case 'left': cp1x = sourcePoint.x - offset; cp1y = sourcePoint.y; break;
                default: cp1x = sourcePoint.x + offset; cp1y = sourcePoint.y; break;
            }

            switch(targetAnchor) {
                case 'top': cp2x = targetPoint.x; cp2y = targetPoint.y - offset; break;
                case 'bottom': cp2x = targetPoint.x; cp2y = targetPoint.y + offset; break;
                case 'left': cp2x = targetPoint.x - offset; cp2y = targetPoint.y; break;
                default: cp2x = targetPoint.x + offset; cp2y = targetPoint.y; break;
            }

            return { cp1x, cp1y, cp2x, cp2y };
        }

        function createBezierPath(d) {
            const source = nodeMap.get(d.source);
            const target = nodeMap.get(d.target);
            if (!source || !target) return '';

            const { source: sourceAnchor, target: targetAnchor } = calculateOptimalAnchors(source, target);
            const sourcePoint = getAnchorPoint(source, sourceAnchor);
            const targetPoint = getAnchorPoint(target, targetAnchor);
            const { cp1x, cp1y, cp2x, cp2y } = getControlPoints(sourcePoint, targetPoint, sourceAnchor, targetAnchor);

            return `M ${sourcePoint.x},${sourcePoint.y} C ${cp1x},${cp1y} ${cp2x},${cp2y} ${targetPoint.x},${targetPoint.y}`;
        }

        function applyLinkMarkers(selection, suffix) {
            const sfx = suffix ? '-' + suffix : '';
            selection.each(function(d) {
                const el = d3.select(this);
                const mode = d.arrowMode || 'none';
                el.attr('marker-end', (mode === 'forward' || mode === 'both') ? `url(#arrow-forward${sfx})` : null);
                el.attr('marker-start', (mode === 'reverse' || mode === 'both') ? `url(#arrow-reverse${sfx})` : null);
            });
        }

        function drawLinks() {
            const linkElements = g.selectAll('.link')
                .data(links, d => `${d.source}-${d.target}`)
                .join('path')
                .attr('class', d => 'link' + (isEditMode ? ' clickable' : ''))
                .attr('d', createBezierPath)
                .attr('stroke', linkColor)
                .attr('opacity', linkOpacity)
                .on('click', isEditMode ? handleLinkClick : null);

            applyLinkMarkers(linkElements, '');

            window.linkElements = linkElements;
        }

        function appendNodeShape(selection) {
            selection.each(function(d) {
                const group = d3.select(this);
                const pt = processTypes[d.processType] || processTypes['process'];
                const color = roleColors[d.role] || '#64748b';
                const fill = color + '33';
                const w = getNodeW(d);
                const h = getNodeH(d);
                let el;

                switch (pt.shape) {
                    case 'rect':
                        el = group.append('rect')
                            .attr('width', w)
                            .attr('height', h)
                            .attr('rx', 8)
                            .attr('ry', 8);
                        break;
                    case 'circle': {
                        // Radius = h so the circle is visually proportional to rectangles
                        const r = h;
                        el = group.append('circle')
                            .attr('cx', w / 2)
                            .attr('cy', h / 2)
                            .attr('r', r);
                        break;
                    }
                    case 'triangle':
                        el = group.append('polygon')
                            .attr('points', `0,0 ${w},0 ${w/2},${h}`);
                        break;
                    case 'hexagon': {
                        const inset = w * 0.2;
                        el = group.append('polygon')
                            .attr('points', `${inset},0 ${w - inset},0 ${w},${h/2} ${w - inset},${h} ${inset},${h} 0,${h/2}`);
                        break;
                    }
                    case 'diamond':
                        el = group.append('polygon')
                            .attr('points', `${w/2},0 ${w},${h/2} ${w/2},${h} 0,${h/2}`);
                        break;
                    default:
                        el = group.append('rect')
                            .attr('width', w)
                            .attr('height', h)
                            .attr('rx', 8)
                            .attr('ry', 8);
                }

                el.attr('class', 'node-shape')
                    .attr('fill', fill)
                    .attr('stroke', color);

                if (pt.dashed) {
                    el.attr('stroke-dasharray', CONFIG.DASHED_STROKE);
                }
            });
        }

        function drawNodes() {
            const nodeElements = g.selectAll('.node')
                .data(nodes, d => d.id)
                .join('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x - getNodeW(d)/2}, ${d.y})`)
                .on('click', handleNodeClick)
                .on('contextmenu', handleNodeRightClick)
                .on('mouseenter', handleNodeHover)
                .on('mouseleave', handleNodeLeave);

            // Drag behavior
            const throttledLinkUpdate = throttle(() => {
                if (window.linkElements) {
                    window.linkElements.attr('d', createBezierPath);
                }
            }, CONFIG.THROTTLE_DELAY);

            const drag = d3.drag()
                .on('start', function(event, d) {
                    if (isDragMode) {
                        d3.select(this).classed('dragging', true);
                        d3.select('body').style('cursor', 'grabbing');
                    }
                })
                .on('drag', function(event, d) {
                    if (isDragMode) {
                        d.x = event.x;
                        d.y = event.y;
                        d3.select(this).attr('transform', `translate(${d.x - getNodeW(d)/2}, ${d.y})`);
                        throttledLinkUpdate();
                    }
                })
                .on('end', function(event, d) {
                    if (isDragMode) {
                        d3.select(this).classed('dragging', false);
                        d3.select('body').style('cursor', 'default');
                        clearAnchorCache();
                        // Final update to ensure links are accurate
                        if (window.linkElements) {
                            window.linkElements.attr('d', createBezierPath);
                        }
                    }
                });

            nodeElements.call(drag);

            // Remove old shapes/text
            nodeElements.selectAll('.node-shape').remove();
            nodeElements.selectAll('text').remove();

            appendNodeShape(nodeElements);

            const textElements = nodeElements.append('text')
                .attr('x', function(d) { return getNodeW(d) / 2; });

            textElements.each(function(d) {
                const w = getNodeW(d);
                const h = getNodeH(d);
                const lines = splitTextSmart(d.name, 3);
                const lineCount = lines.length;
                const pt = processTypes[d.processType] || processTypes['process'];
                const lineHeight = 12;
                const totalTextHeight = lineCount * lineHeight;
                // Triangle (flat top): align text near the top edge where it's widest
                const startY = pt.shape === 'triangle'
                    ? lineHeight
                    : (h - totalTextHeight) / 2 + lineHeight * 0.8;

                const el = d3.select(this);
                lines.forEach((line, i) => {
                    el.append('tspan')
                        .attr('x', w / 2)
                        .attr('y', startY + i * lineHeight)
                        .text(line);
                });
            });

            window.nodeElements = nodeElements;
        }

        // ==================== VIEWER STUBS (overridden in edit mode) ====================
        // These no-op stubs let view-mode code reference edit functions without errors.
        // The real implementations follow inside the EDIT-ONLY block below.
        function toggleEditMode() {}
        function toggleSettings() {}
        function closeLinkEditor() {}
        function cancelLinkCreation() {}
        function closeNodeModal() {}
        function deselectAnnotation() {}
        function closeAnnotationContextMenu() {}
        function setDrawTool() {}
        function handleDrawMouseDown() {}
        function handleDrawMouseMove() {}
        function handleDrawMouseUp() {}
        function selectAnnotation() {}
        function addResizeHandle() {}
        function openAnnotationContextMenu() {}
        function saveToLocalStorage() {}
        function loadFromLocalStorage() { return false; }
        function handleLinkClick() {}
        function handleNodeRightClick() {}

        

        // ==================== LEGEND AND FILTERING ====================

        function createLegendShapeSVG(shape, dashed) {
            const svgNS = 'http://www.w3.org/2000/svg';
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('viewBox', '0 0 12 12');
            svg.style.width = '20px';
            svg.style.height = '20px';
            svg.style.flexShrink = '0';

            let el;
            switch (shape) {
                case 'rect':
                    el = document.createElementNS(svgNS, 'rect');
                    el.setAttribute('x', '1.5');
                    el.setAttribute('y', '1.5');
                    el.setAttribute('width', '9');
                    el.setAttribute('height', '9');
                    el.setAttribute('rx', '2');
                    break;
                case 'circle':
                    el = document.createElementNS(svgNS, 'circle');
                    el.setAttribute('cx', '6');
                    el.setAttribute('cy', '6');
                    el.setAttribute('r', '4.5');
                    break;
                case 'triangle':
                    el = document.createElementNS(svgNS, 'polygon');
                    el.setAttribute('points', '1.5,1.5 10.5,1.5 6,10.5');
                    break;
                case 'hexagon':
                    el = document.createElementNS(svgNS, 'polygon');
                    el.setAttribute('points', '3,1.5 9,1.5 11.5,6 9,10.5 3,10.5 0.5,6');
                    break;
                case 'diamond':
                    el = document.createElementNS(svgNS, 'polygon');
                    el.setAttribute('points', '6,1.5 10.5,6 6,10.5 1.5,6');
                    break;
                default:
                    el = document.createElementNS(svgNS, 'rect');
                    el.setAttribute('x', '1.5');
                    el.setAttribute('y', '1.5');
                    el.setAttribute('width', '9');
                    el.setAttribute('height', '9');
                    el.setAttribute('rx', '2');
            }

            el.setAttribute('fill', 'none');
            el.setAttribute('stroke', '#94a3b8');
            el.setAttribute('stroke-width', '0.8');
            if (dashed) {
                el.setAttribute('stroke-dasharray', '2,1.5');
            }

            svg.appendChild(el);
            return svg;
        }

        function rebuildLegend() {
            const legend = document.getElementById('legend');
            legend.innerHTML = '';

            // Role header
            const roleH3 = document.createElement('h3');
            roleH3.textContent = roleCategoryLabel;
            legend.appendChild(roleH3);

            // Role items
            Object.keys(roleColors).forEach(role => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.setAttribute('data-role', role);

                const colorDiv = document.createElement('div');
                colorDiv.className = 'legend-color';
                colorDiv.style.background = roleColors[role];
                item.appendChild(colorDiv);

                item.appendChild(document.createTextNode(role));

                item.addEventListener('click', function() {
                    toggleRoleFilter(role);
                });

                legend.appendChild(item);
            });

            // Clear filter button
            const clearDiv = document.createElement('div');
            clearDiv.className = 'legend-clear';
            clearDiv.textContent = 'Clear Filter';
            clearDiv.addEventListener('click', clearRoleFilter);
            legend.appendChild(clearDiv);

            // Process type header
            const ptH3 = document.createElement('h3');
            ptH3.style.marginTop = '10px';
            ptH3.textContent = processTypeCategoryLabel;
            legend.appendChild(ptH3);

            // Process type items
            Object.keys(processTypes).forEach(key => {
                const pt = processTypes[key];
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.setAttribute('data-process-type', key);

                item.appendChild(createLegendShapeSVG(pt.shape, pt.dashed));
                item.appendChild(document.createTextNode(pt.label));

                item.addEventListener('click', function() {
                    toggleProcessTypeFilter(key);
                });

                legend.appendChild(item);
            });
        }

        function setupLegend() {
            rebuildLegend();
        }

        function clearLegendHighlights() {
            document.querySelectorAll('.legend-item').forEach(item => {
                item.classList.remove('active', 'dimmed');
            });
            window.nodeElements.classed('role-filtered', false);
            window.linkElements.attr('opacity', linkOpacity);
        }

        function toggleRoleFilter(role) {
            // Clear any process type filter first
            selectedProcessType = null;

            if (selectedRole === role) {
                selectedRole = null;
                clearLegendHighlights();
            } else {
                selectedRole = role;
                document.querySelectorAll('.legend-item').forEach(item => {
                    const itemRole = item.getAttribute('data-role');
                    if (itemRole === role) {
                        item.classList.add('active');
                        item.classList.remove('dimmed');
                    } else {
                        item.classList.remove('active');
                        item.classList.add('dimmed');
                    }
                });

                window.nodeElements.classed('role-filtered', d => d.role !== role);
                window.linkElements.attr('opacity', d => {
                    const sourceNode = nodeMap.get(d.source);
                    const targetNode = nodeMap.get(d.target);
                    return (sourceNode && sourceNode.role === role) || (targetNode && targetNode.role === role) ? 0.8 : 0.1;
                });
                rebuildMaps();
            }
        }

        function toggleProcessTypeFilter(pt) {
            // Clear any role filter first
            selectedRole = null;

            if (selectedProcessType === pt) {
                selectedProcessType = null;
                clearLegendHighlights();
            } else {
                selectedProcessType = pt;
                document.querySelectorAll('.legend-item').forEach(item => {
                    const itemPt = item.getAttribute('data-process-type');
                    if (itemPt === pt) {
                        item.classList.add('active');
                        item.classList.remove('dimmed');
                    } else {
                        item.classList.remove('active');
                        item.classList.add('dimmed');
                    }
                });

                window.nodeElements.classed('role-filtered', d => (d.processType || 'process') !== pt);
                window.linkElements.attr('opacity', d => {
                    const sourceNode = nodeMap.get(d.source);
                    const targetNode = nodeMap.get(d.target);
                    const srcMatch = sourceNode && (sourceNode.processType || 'process') === pt;
                    const tgtMatch = targetNode && (targetNode.processType || 'process') === pt;
                    return srcMatch || tgtMatch ? 0.8 : 0.1;
                });
                rebuildMaps();
            }
        }

        function clearRoleFilter() {
            selectedRole = null;
            selectedProcessType = null;
            clearLegendHighlights();
        }

        // ==================== SIDE PANEL ====================

        function showSidePanel(nodeData) {
            const panel = document.getElementById('sidepanel');
            const content = document.getElementById('panel-content');

            const connected = adjacency.get(nodeData.id) || new Set();
            const connectedNodes = Array.from(connected).map(id => nodeMap.get(id)).filter(Boolean);

            const resources = nodeData.resources || [];

            // Clear existing content
            content.innerHTML = '';

            // Create header with node name (safe from XSS)
            const h2 = document.createElement('h2');
            h2.textContent = nodeData.name;
            content.appendChild(h2);

            // Create role badge
            const roleBadge = document.createElement('span');
            roleBadge.className = 'role-badge';
            roleBadge.style.background = roleColors[nodeData.role];
            roleBadge.textContent = nodeData.role;
            content.appendChild(roleBadge);

            // Create description
            const description = document.createElement('p');
            description.className = 'description';
            description.textContent = nodeData.desc;
            content.appendChild(description);

            // Create connected activities section
            const connectedSection = document.createElement('div');
            connectedSection.className = 'section';
            const connectedH3 = document.createElement('h3');
            connectedH3.textContent = `Connected Activities (${connectedNodes.length})`;
            connectedSection.appendChild(connectedH3);

            connectedNodes.forEach(node => {
                const item = document.createElement('div');
                item.className = 'connection-item';
                item.onclick = () => highlightNode(node.id);

                const dot = document.createElement('div');
                dot.className = 'connection-dot';
                dot.style.background = roleColors[node.role];
                item.appendChild(dot);

                const span = document.createElement('span');
                span.textContent = node.name;
                item.appendChild(span);

                connectedSection.appendChild(item);
            });
            content.appendChild(connectedSection);

            // Create process type section
            const processSection = document.createElement('div');
            processSection.className = 'section';
            const processH3 = document.createElement('h3');
            processH3.textContent = 'Process Type';
            processSection.appendChild(processH3);
            const processP = document.createElement('p');
            processP.textContent = (processTypes[nodeData.processType] || processTypes['process']).label;
            processSection.appendChild(processP);
            content.appendChild(processSection);

            // Create resources section if resources exist
            if (resources.length > 0) {
                const resourcesSection = document.createElement('div');
                resourcesSection.className = 'section';
                const resourcesH3 = document.createElement('h3');
                resourcesH3.textContent = 'Additional Resources';
                resourcesSection.appendChild(resourcesH3);

                resources.forEach(r => {
                    if (typeof r === 'object' && r.text) {
                        if (r.url) {
                            const href = r.url.match(/^https?:\/\/|^file:\/\//) ? r.url : 'https://' + r.url;
                            const link = document.createElement('a');
                            link.href = href;
                            link.className = 'resource-link';
                            link.target = '_blank';
                            link.rel = 'noopener';
                            link.textContent = '‚Ä¢ ' + r.text;
                            resourcesSection.appendChild(link);
                        } else {
                            const span = document.createElement('span');
                            span.className = 'resource-link';
                            span.textContent = '‚Ä¢ ' + r.text;
                            resourcesSection.appendChild(span);
                        }
                    } else {
                        const label = typeof r === 'string' ? r : (r.text || r.url || '');
                        const span = document.createElement('span');
                        span.className = 'resource-link';
                        span.textContent = '‚Ä¢ ' + label;
                        resourcesSection.appendChild(span);
                    }
                });

                content.appendChild(resourcesSection);
            }

            panel.classList.add('open');
            document.getElementById('canvas').classList.add('panel-open');
        }

        function closeSidePanel() {
            document.getElementById('sidepanel').classList.remove('open');
            document.getElementById('canvas').classList.remove('panel-open');
        }

        function highlightNode(nodeId) {
            const nodeData = nodeMap.get(nodeId);
            if (nodeData) handleNodeClick(null, nodeData);
        }

        // ==================== NODE INTERACTION ====================

        function handleNodeClick(event, d) {
            if (event) event.stopPropagation();

            // Suppress node interactions in draw tool mode (except 'none' and 'select')
            if (isEditMode && currentDrawTool !== 'none' && currentDrawTool !== 'select') return;

            // In edit mode with link creation active
            if (isEditMode && currentDrawTool === 'none' && linkSourceNode) {
                completeLinkCreation(d.id);
                return;
            }

            // In edit mode, start link creation
            if (isEditMode && currentDrawTool === 'none' && !linkSourceNode) {
                startLinkCreation(d.id);
                return;
            }

            if (isDragMode) return;

            if (selectedNode === d.id) {
                clearSelection();
                closeSidePanel();
                return;
            }

            selectedNode = d.id;
            const connected = adjacency.get(d.id) || new Set();

            window.nodeElements
                .classed('dimmed', n => n.id !== d.id && !connected.has(n.id))
                .classed('highlighted', n => n.id === d.id);

            window.linkElements
                .classed('dimmed', l => l.source !== d.id && l.target !== d.id)
                .classed('highlighted', l => l.source === d.id || l.target === d.id);

            // Update arrow markers for highlight/dim states
            window.linkElements.each(function(l) {
                const el = d3.select(this);
                const isConnected = l.source === d.id || l.target === d.id;
                const suffix = isConnected ? 'highlighted' : 'dimmed';
                const mode = l.arrowMode || 'none';
                el.attr('marker-end', (mode === 'forward' || mode === 'both') ? `url(#arrow-forward-${suffix})` : null);
                el.attr('marker-start', (mode === 'reverse' || mode === 'both') ? `url(#arrow-reverse-${suffix})` : null);
            });

            showSidePanel(d);
        }

        const tooltip = d3.select('#tooltip');

        function handleNodeHover(event, d) {
            if (isDragMode || isEditMode) return;

            tooltip.select('h4').text(d.name);
            tooltip.select('p').text(d.desc);
            tooltip.select('.role')
                .text(d.role)
                .style('background', roleColors[d.role]);

            tooltip
                .style('left', (event.pageX + 15) + 'px')
                .style('top', (event.pageY - 10) + 'px')
                .classed('visible', true);
        }

        function handleNodeLeave() {
            tooltip.classed('visible', false);
        }

        // ==================== MODE TOGGLES ====================

        function toggleDragMode() {
            isDragMode = !isDragMode;
            const btn = document.getElementById('drag-btn');

            if (isDragMode) {
                btn.textContent = 'Lock';
                btn.classList.add('active');
                document.getElementById('canvas').style.cursor = 'grab';
                if (isEditMode) toggleEditMode();
            } else {
                btn.textContent = 'Drag';
                btn.classList.remove('active');
                document.getElementById('canvas').style.cursor = 'default';
            }
        }

        function updateMarkerColors() {
            const color = isLightMode ? '#4b5563' : linkColor;
            const highlightColor = isLightMode ? '#1e293b' : '#94a3b8';
            defs.select('#arrow-forward path').attr('fill', color);
            defs.select('#arrow-reverse path').attr('fill', color);
            defs.select('#arrow-forward-highlighted path').attr('fill', highlightColor);
            defs.select('#arrow-reverse-highlighted path').attr('fill', highlightColor);
            defs.select('#arrow-forward-dimmed path').attr('fill', color);
            defs.select('#arrow-reverse-dimmed path').attr('fill', color);
        }

        function toggleLightDarkMode(fromCheckbox) {
            const checkbox = document.getElementById('theme-checkbox');
            if (!fromCheckbox) {
                checkbox.checked = !checkbox.checked;
            }
            isLightMode = !checkbox.checked;

            if (isLightMode) {
                document.body.classList.add('light-mode');
            } else {
                document.body.classList.remove('light-mode');
            }
            updateMarkerColors();
        }

        

        function clearSelection() {
            selectedNode = null;
            if (window.nodeElements) {
                window.nodeElements.classed('dimmed', false).classed('highlighted', false);
                window.linkElements.classed('dimmed', false).classed('highlighted', false);
                // Reset arrow markers to normal
                applyLinkMarkers(window.linkElements, '');
            }
        }

        

        // ==================== NAV LINKS ====================

        function rebuildNavLinks() {
            const panel = document.getElementById('nav-links-panel');
            panel.innerHTML = '';

            const hasLinks = navLinks.length > 0;
            const showPanel = hasLinks || isEditMode;
            panel.classList.toggle('hidden', !showPanel);

            navLinks.forEach((nl, index) => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.gap = '4px';

                const btn = document.createElement('button');
                btn.className = 'nav-link-btn';
                btn.textContent = nl.label || 'Link';
                btn.style.flex = '1';
                btn.onclick = () => {
                    if (!isEditMode) {
                        window.open(nl.url, '_blank');
                    }
                };
                row.appendChild(btn);

                if (isEditMode) {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'nav-link-delete';
                    editBtn.textContent = '\u270E';
                    editBtn.title = 'Edit';
                    editBtn.onclick = () => editNavLink(index);
                    row.appendChild(editBtn);

                    const delBtn = document.createElement('button');
                    delBtn.className = 'nav-link-delete';
                    delBtn.textContent = '\u00d7';
                    delBtn.title = 'Delete';
                    delBtn.onclick = () => deleteNavLink(index);
                    row.appendChild(delBtn);
                }

                panel.appendChild(row);
            });

            if (isEditMode) {
                const addBtn = document.createElement('button');
                addBtn.className = 'nav-link-add';
                addBtn.textContent = '+ Add Nav Link';
                addBtn.onclick = addNavLink;
                panel.appendChild(addBtn);
            }
        }

        

        // ==================== ANNOTATIONS ====================

        

        function drawAnnotations() {
            const layer = g.select('.annotation-layer');
            if (!layer.node()) return;

            const groups = layer.selectAll('.annotation')
                .data(annotations, d => d.id);

            groups.exit().remove();

            const enter = groups.enter().append('g')
                .attr('class', 'annotation');

            const merged = enter.merge(groups);

            merged.each(function(d) {
                const group = d3.select(this);
                group.selectAll('*').remove();

                const dashArray = d.dashed ? '8,4' : null;

                switch (d.type) {
                    case 'line': {
                        const el = group.append('line')
                            .attr('x1', d.x).attr('y1', d.y)
                            .attr('x2', d.x2).attr('y2', d.y2)
                            .attr('stroke', d.stroke)
                            .attr('stroke-width', d.strokeWidth)
                            .attr('opacity', d.opacity);
                        if (dashArray) el.attr('stroke-dasharray', dashArray);
                        break;
                    }
                    case 'rect': {
                        const el = group.append('rect')
                            .attr('x', d.x).attr('y', d.y)
                            .attr('width', d.width).attr('height', d.height)
                            .attr('fill', 'none')
                            .attr('stroke', d.stroke)
                            .attr('stroke-width', d.strokeWidth)
                            .attr('opacity', d.opacity);
                        if (dashArray) el.attr('stroke-dasharray', dashArray);
                        break;
                    }
                    case 'circle': {
                        const el = group.append('circle')
                            .attr('cx', d.x).attr('cy', d.y)
                            .attr('r', d.radius)
                            .attr('fill', 'none')
                            .attr('stroke', d.stroke)
                            .attr('stroke-width', d.strokeWidth)
                            .attr('opacity', d.opacity);
                        if (dashArray) el.attr('stroke-dasharray', dashArray);
                        break;
                    }
                    case 'text':
                        group.append('text')
                            .attr('x', d.x).attr('y', d.y)
                            .attr('fill', d.stroke)
                            .attr('font-size', d.fontSize || 14)
                            .attr('opacity', d.opacity)
                            .text(d.text || '');
                        break;
                }

                // Selection outline
                if (selectedAnnotation === d.id) {
                    const bbox = group.node().getBBox();
                    group.append('rect')
                        .attr('class', 'annotation-selection-outline')
                        .attr('x', bbox.x - 3).attr('y', bbox.y - 3)
                        .attr('width', bbox.width + 6).attr('height', bbox.height + 6)
                        .attr('fill', 'none')
                        .attr('stroke', '#f97316')
                        .attr('stroke-width', 1)
                        .attr('stroke-dasharray', '4,2')
                        .attr('pointer-events', 'none');

                    // Resize handles
                    if (d.type === 'rect') {
                        addResizeHandle(group, d, bbox.x, bbox.y, 'nw');
                        addResizeHandle(group, d, bbox.x + bbox.width, bbox.y, 'ne');
                        addResizeHandle(group, d, bbox.x, bbox.y + bbox.height, 'sw');
                        addResizeHandle(group, d, bbox.x + bbox.width, bbox.y + bbox.height, 'se');
                    } else if (d.type === 'circle') {
                        addResizeHandle(group, d, d.x + d.radius, d.y, 'radius');
                    } else if (d.type === 'line') {
                        addResizeHandle(group, d, d.x, d.y, 'start');
                        addResizeHandle(group, d, d.x2, d.y2, 'end');
                    }
                }

                // Click to select in select mode
                group.on('click', function(event) {
                    if (currentDrawTool === 'select') {
                        event.stopPropagation();
                        selectAnnotation(d.id);
                    }
                });

                // Right-click context menu
                group.on('contextmenu', function(event) {
                    if (isEditMode) {
                        event.preventDefault();
                        event.stopPropagation();
                        selectAnnotation(d.id);
                        openAnnotationContextMenu(event, d);
                    }
                });

                // Drag to move in select mode
                if (currentDrawTool === 'select') {
                    const drag = d3.drag()
                        .on('start', function(event) {
                            event.sourceEvent.stopPropagation();
                        })
                        .on('drag', function(event) {
                            if (selectedAnnotation !== d.id) return;
                            const dx = event.dx;
                            const dy = event.dy;
                            d.x += dx;
                            d.y += dy;
                            if (d.type === 'line') {
                                d.x2 += dx;
                                d.y2 += dy;
                            }
                            drawAnnotations();
                        });
                    group.call(drag);
                }
            });
        }

        

        // ==================== ZOOM ====================

        function zoomIn() {
            svg.transition().duration(300).call(zoom.scaleBy, 1.3);
        }

        function zoomOut() {
            svg.transition().duration(300).call(zoom.scaleBy, 0.7);
        }

        function resetView() {
            svg.transition().duration(500).call(
                zoom.transform,
                d3.zoomIdentity.translate(defaultPanX, defaultPanY).scale(defaultZoomLevel)
            );
        }

        // ==================== INITIALIZATION ====================

        document.addEventListener('DOMContentLoaded', function() {
            // Try to load from localStorage first
            if (!loadFromLocalStorage()) {
                // Use defaults
                nodes = JSON.parse(JSON.stringify(defaultNodes));
                links = JSON.parse(JSON.stringify(defaultLinks));
                navLinks = JSON.parse(JSON.stringify(defaultNavLinks));
                annotations = JSON.parse(JSON.stringify(defaultAnnotations));
                nextAnnotationId = annotations.reduce((max, a) => Math.max(max, a.id || 0), 0) + 1;
                rebuildMaps();
                initVisualization();
            }

            setupLegend();
            rebuildNavLinks();
            updateMarkerColors();
            svg.call(zoom.transform, d3.zoomIdentity.translate(defaultPanX, defaultPanY).scale(defaultZoomLevel));

            // Close link editor / annotation context menu on outside click
            document.addEventListener('click', (e) => {
                if (editingLink && !e.target.closest('#link-editor') && !e.target.closest('.link')) {
                    closeLinkEditor();
                }
                if (!e.target.closest('#annotation-context-menu') && !e.target.closest('.annotation')) {
                    closeAnnotationContextMenu();
                }
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;

            if (e.key === 'Escape') {
                
                {
                    clearSelection();
                    closeSidePanel();
                }
            }
            
            if (e.key === '+' || e.key === '=') zoomIn();
            if (e.key === '-') zoomOut();
            if (e.key === '0') resetView();
            if (e.key === 'd' || e.key === 'D') toggleDragMode();
            if (e.key === 'l' || e.key === 'L') toggleLightDarkMode();
            
        });
    </script>

</body></html>